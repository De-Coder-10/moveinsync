 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vehicle Tracking Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SockJS + STOMP for WebSocket real-time streaming (Functionality #1) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #f1f5f9; height: 100vh; overflow: hidden; }
        .app { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; background: #1e293b; border-bottom: 1px solid #334155; flex-shrink: 0; z-index: 1000; }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header h1 span { color: #3b82f6; }
        .header-controls { display: flex; align-items: center; gap: 20px; font-size: 13px; }
        .conn-badge { display: flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .conn-ws { background: rgba(34,197,94,0.15); color: #22c55e; border: 1px solid rgba(34,197,94,0.3); }
        .conn-poll { background: rgba(245,158,11,0.15); color: #f59e0b; border: 1px solid rgba(245,158,11,0.3); }
        .conn-disc { background: rgba(239,68,68,0.15); color: #ef4444; border: 1px solid rgba(239,68,68,0.3); }
        .pulse { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* Layout */
        .main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 310px; min-width: 310px; background: #1e293b; border-right: 1px solid #334155; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* Cards */
        .card { background: #334155; border-radius: 10px; padding: 14px; border: 1px solid #475569; }
        .card-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: #94a3b8; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .card-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .card-row:last-child { border-bottom: none; }
        .card-row .lbl { color: #94a3b8; }
        .card-row .val { font-weight: 600; color: #f1f5f9; text-align: right; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .b-progress { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
        .b-completed { background: rgba(34,197,94,.15); color: #22c55e; border: 1px solid rgba(34,197,94,.3); }
        .b-pending { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.3); }
        .b-arrived { background: rgba(59,130,246,.15); color: #3b82f6; border: 1px solid rgba(59,130,246,.3); }

        /* Stats grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; }
        .stat-box { background: #1e293b; border-radius: 8px; padding: 9px; text-align: center; }
        .stat-val { font-size: 18px; font-weight: 700; color: #f1f5f9; }
        .stat-lbl { font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        .stat-box.full { grid-column: span 2; }

        /* Sim buttons */
        .sim-buttons { display: flex; flex-direction: column; gap: 7px; }
        .sim-btn { display: flex; align-items: center; gap: 9px; padding: 9px 12px; border: 1px solid #475569; border-radius: 8px; background: #1e293b; color: #f1f5f9; font-size: 12px; font-weight: 500; cursor: pointer; transition: all .2s; }
        .sim-btn:hover:not(:disabled) { background: #475569; transform: translateY(-1px); }
        .sim-btn:disabled { opacity: .4; cursor: not-allowed; }
        .sim-btn.btn-pickup { border-left: 3px solid #3b82f6; }
        .sim-btn.btn-route  { border-left: 3px solid #a855f7; }
        .sim-btn.btn-drive  { border-left: 3px solid #f59e0b; }
        .sim-btn.btn-office { border-left: 3px solid #22c55e; }
        .sim-btn.btn-reset  { border-left: 3px solid #ef4444; }
        .sim-status { text-align: center; padding: 7px; font-size: 11px; color: #94a3b8; min-height: 28px; }
        .sim-status.active { color: #f59e0b; }

        /* Event / Notification list */
        .item-list { list-style: none; display: flex; flex-direction: column; gap: 6px; max-height: 160px; overflow-y: auto; }
        .item-list::-webkit-scrollbar { width: 4px; }
        .item-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        .ev-item { display: flex; align-items: flex-start; gap: 8px; padding: 7px 9px; background: #1e293b; border-radius: 7px; font-size: 11px; border-left: 3px solid #475569; animation: slideIn .3s ease; }
        .ev-item.pickup   { border-left-color: #3b82f6; }
        .ev-item.office   { border-left-color: #a855f7; }
        .ev-item.complete { border-left-color: #22c55e; }
        .ev-item.notif    { border-left-color: #f59e0b; }
        .ev-icon { font-size: 15px; flex-shrink: 0; margin-top: 1px; }
        .ev-title { font-weight: 700; color: #f1f5f9; }
        .ev-sub   { color: #64748b; font-size: 10px; margin-top: 1px; }
        .list-empty { text-align: center; color: #64748b; font-size: 12px; padding: 16px 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-8px); } to { opacity: 1; transform: translateX(0); } }

        /* Map */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .map-legend { position: absolute; bottom: 30px; right: 10px; background: rgba(30,41,59,.92); backdrop-filter: blur(8px); border: 1px solid #475569; border-radius: 10px; padding: 10px 14px; z-index: 999; font-size: 11px; }
        .map-legend h4 { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin-bottom: 7px; }
        .leg-item { display: flex; align-items: center; gap: 7px; padding: 2px 0; color: #cbd5e1; }
        .leg-dot  { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
        .leg-line { width: 16px; height: 3px; border-radius: 2px; flex-shrink: 0; }

        /* Toasts */
        .toast-wrap { position: fixed; top: 65px; right: 18px; z-index: 9999; display: flex; flex-direction: column; gap: 7px; }
        .toast { padding: 10px 18px; border-radius: 8px; font-size: 12px; font-weight: 500; color: white; box-shadow: 0 8px 24px rgba(0,0,0,.3); animation: tIn .3s ease, tOut .3s ease 3.7s forwards; display: flex; align-items: center; gap: 8px; }
        .t-success { background: #16a34a; } .t-info { background: #2563eb; } .t-warn { background: #d97706; } .t-error { background: #dc2626; }
        @keyframes tIn  { from { opacity:0; transform: translateX(30px); } to { opacity:1; transform: translateX(0); } }
        @keyframes tOut { from { opacity:1; } to { opacity:0; transform: translateY(-8px); } }

        /* Leaflet custom */
        .vehicle-marker { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.5)); }
        .emoji-lbl { background: none!important; border: none!important; font-size: 20px; }
        .leaflet-popup-content-wrapper { background: #1e293b; color: #f1f5f9; border: 1px solid #475569; border-radius: 8px; }
        .leaflet-popup-tip { background: #1e293b; }
        .leaflet-popup-content { font-size: 12px; }
    </style>
</head>
<body>
<div class="app">

    <!-- Header -->
    <header class="header">
        <h1>üöê <span>Vehicle Tracking</span> ‚Äî Real-Time Dashboard</h1>
        <div class="header-controls">
            <span id="connBadge" class="conn-badge conn-disc"><span class="pulse"></span> Connecting‚Ä¶</span>
        </div>
    </header>

    <div class="main">
        <!-- Sidebar -->
        <aside class="sidebar">

            <!-- Trip Info -->
            <div class="card">
                <div class="card-title">üó∫Ô∏è Trip Information</div>
                <div class="card-row"><span class="lbl">Trip ID</span><span class="val" id="tripId">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Status</span><span id="tripStatus"><span class="badge b-progress">Loading</span></span></div>
                <div class="card-row"><span class="lbl">Vehicle</span><span class="val" id="vehicleReg">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Started</span><span class="val" id="tripStart">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Ended</span><span class="val" id="tripEnd">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Distance</span><span class="val" id="tripDist">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Duration</span><span class="val" id="tripDur">‚Äî</span></div>
            </div>

            <!-- Driver Details (Functionality #6) -->
            <div class="card">
                <div class="card-title">üë§ Driver Details</div>
                <div class="card-row"><span class="lbl">Name</span><span class="val" id="driverName">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Phone</span><span class="val" id="driverPhone">‚Äî</span></div>
                <div class="card-row"><span class="lbl">License</span><span class="val" id="driverLic">‚Äî</span></div>
            </div>

            <!-- Pickup Status -->
            <div class="card">
                <div class="card-title">üìç Pickup Point</div>
                <div class="card-row"><span class="lbl">Status</span><span id="pickupStatus"><span class="badge b-pending">Pending</span></span></div>
                <div class="card-row"><span class="lbl">Location</span><span class="val" id="pickupCoords">‚Äî</span></div>
                <div class="card-row"><span class="lbl">Radius</span><span class="val" id="pickupRadius">‚Äî</span></div>
            </div>

            <!-- Live Stats -->
            <div class="card">
                <div class="card-title">üìä Live Stats</div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="stat-val" id="statPings">0</div><div class="stat-lbl">GPS Pings</div></div>
                    <div class="stat-box"><div class="stat-val" id="statEvents">0</div><div class="stat-lbl">Events</div></div>
                    <div class="stat-box"><div class="stat-val" id="statSpeed">‚Äî</div><div class="stat-lbl">Speed km/h</div></div>
                    <div class="stat-box"><div class="stat-val" id="statDist">0</div><div class="stat-lbl">Dist km</div></div>
                    <div class="stat-box full"><div class="stat-val" id="statEta">‚Äî</div><div class="stat-lbl">ETA to next stop</div></div>
                </div>
            </div>

            <!-- Simulation Controls -->
            <div class="card">
                <div class="card-title">üéÆ Simulation Controls</div>
                <div class="sim-buttons">
                    <button class="sim-btn btn-route"  onclick="loadRoadRoute()"><span>üó∫Ô∏è</span> Load Road Route</button>
                    <button class="sim-btn btn-pickup" onclick="simulatePickup()"><span>üìç</span> Arrive at Pickup</button>
                    <button class="sim-btn btn-drive"  onclick="simulateDrive()"><span>üöó</span> Drive to Office</button>
                    <button class="sim-btn btn-office" onclick="simulateOffice()"><span>üè¢</span> Arrive at Office</button>
                    <button class="sim-btn btn-reset"  onclick="resetTrip()"><span>üîÑ</span> Reset Trip</button>
                </div>
                <div class="sim-status" id="simStatus">Ready to simulate</div>
            </div>

            <!-- Notification Feed (Functionality #5 ‚Äî simulated push/SMS) -->
            <div class="card">
                <div class="card-title">üîî Notification Feed <span style="color:#f59e0b;font-size:9px;margin-left:auto">simulated</span></div>
                <ul class="item-list" id="notifList">
                    <li class="list-empty">Notifications will appear here‚Ä¶</li>
                </ul>
            </div>

            <!-- Event Log (Functionality #7 + #8) -->
            <div class="card">
                <div class="card-title">üìã Event Log</div>
                <ul class="item-list" id="eventList">
                    <li class="list-empty">No events yet. Run a simulation!</li>
                </ul>
            </div>

        </aside>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
            <div class="map-legend">
                <h4>Legend</h4>
                <div class="leg-item"><span class="leg-dot" style="background:rgba(59,130,246,.4);border:2px solid #3b82f6"></span> Pickup (50m)</div>
                <div class="leg-item"><span class="leg-dot" style="background:rgba(34,197,94,.4);border:2px solid #22c55e"></span> Office (100m)</div>
                <div class="leg-item"><span class="leg-line" style="background:#a855f7;height:3px;border-top:2px dashed #a855f7;background:none"></span> Road Route</div>
                <div class="leg-item"><span class="leg-line" style="background:#f59e0b"></span> Route Trail</div>
                <div class="leg-item"><span style="font-size:15px">üöê</span> Vehicle (WebSocket)</div>
            </div>
        </div>
    </div>
</div>

<div id="toasts" class="toast-wrap"></div>

<script>
// ===========================
// State
// ===========================
let map, vehicleMarker, routeLine, pickupCircle, officeCircle, pickupMarker, officeMarker;
let roadRouteLayer = null;      // highlighted road path (OSRM geometry)
let roadRouteWaypoints = [];    // road-snapped [lat,lng] array for simulation
let stompClient = null;
let wsConnected = false;
let previousEventCount = 0;
let isSimulating = false;
let pollInterval;
let routePoints = [];

// ===========================
// Map init
// ===========================
function initMap() {
    map = L.map('map', { zoomControl: true }).setView([12.9618, 77.5848], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a>', maxZoom: 19
    }).addTo(map);
}

// ===========================
// Toasts
// ===========================
function toast(msg, type = 'info') {
    const el = document.createElement('div');
    el.className = 'toast t-' + type;
    el.innerHTML = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove && el.remove(), 4000);
}

// ===========================
// WebSocket ‚Äî Functionality #1
// Real-time location streaming via STOMP over SockJS
// ===========================
function connectWebSocket() {
    try {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // suppress console noise

        stompClient.connect({}, function(frame) {
            wsConnected = true;
            setConnBadge('ws');
            toast('üîå WebSocket connected ‚Äî live updates active', 'info');

            // Subscribe to real-time location feed
            stompClient.subscribe('/topic/location-updates', function(msg) {
                const data = JSON.parse(msg.body);
                handleWsLocationUpdate(data);
            });
        }, function(err) {
            wsConnected = false;
            setConnBadge('poll');
            // Auto-reconnect after 5s
            setTimeout(connectWebSocket, 5000);
        });
    } catch (e) {
        setConnBadge('disc');
    }
}

function setConnBadge(state) {
    const el = document.getElementById('connBadge');
    if (state === 'ws') {
        el.className = 'conn-badge conn-ws';
        el.innerHTML = '<span class="pulse"></span> WebSocket Live';
    } else if (state === 'poll') {
        el.className = 'conn-badge conn-poll';
        el.innerHTML = '<span class="pulse"></span> Polling fallback';
    } else {
        el.className = 'conn-badge conn-disc';
        el.innerHTML = '<span class="pulse"></span> Disconnected';
    }
}

// ===========================
// Handle live WebSocket ping
// Updates map position + speed + distance instantly (no polling needed)
// ===========================
function handleWsLocationUpdate(upd) {
    const latLng = [upd.latitude, upd.longitude];

    // Move vehicle marker
    if (!vehicleMarker) {
        vehicleMarker = L.marker(latLng, {
            icon: L.divIcon({ html: '<div class="vehicle-marker">üöê</div>', className: '', iconSize: [36,36], iconAnchor: [18,18] }),
            zIndexOffset: 1000
        }).addTo(map);
    }
    vehicleMarker.setLatLng(latLng);
    vehicleMarker.setPopupContent(
        '<b>Vehicle</b><br>Speed: ' + upd.speed.toFixed(1) + ' km/h' +
        '<br>Lat: ' + upd.latitude.toFixed(5) + '<br>Lon: ' + upd.longitude.toFixed(5) +
        '<br>Status: ' + upd.tripStatus
    );

    // Extend route trail
    routePoints.push(latLng);
    if (routeLine) { routeLine.setLatLngs(routePoints); }
    else {
        routeLine = L.polyline(routePoints, { color: '#f59e0b', weight: 3.5, opacity: 0.85, lineJoin: 'round' }).addTo(map);
    }

    // Update live stats immediately
    document.getElementById('statSpeed').textContent = upd.speed.toFixed(0);
    document.getElementById('statDist').textContent = (upd.totalDistanceKm || 0).toFixed(2);
}

// ===========================
// Polling (every 4s) ‚Äî fallback for other data
// trip status, events, pickup status, driver info, ETA
// ===========================
async function refreshDashboard() {
    try {
        const res = await fetch('/api/dashboard/data');
        if (!res.ok) throw new Error();
        const data = await res.json();

        if (!wsConnected) setConnBadge('poll');

        updateTripInfo(data);
        updateDriverInfo(data);
        updatePickupInfo(data);
        updateStats(data);
        updateMapStaticElements(data);
        updateEvents(data);
        updateNotifications(data);
    } catch (e) {
        if (!wsConnected) setConnBadge('disc');
    }
}

// ===========================
// Sidebar updaters
// ===========================
function fmt(iso) {
    if (!iso) return '‚Äî';
    return new Date(iso).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function updateTripInfo(data) {
    if (!data.trips.length) return;
    const t = data.trips[0];
    document.getElementById('tripId').textContent = '#' + t.id;
    document.getElementById('vehicleReg').textContent = t.vehicleReg;
    document.getElementById('tripStart').textContent = fmt(t.startTime);
    document.getElementById('tripEnd').textContent = t.endTime ? fmt(t.endTime) : '‚Äî';
    document.getElementById('tripDist').textContent = t.totalDistanceKm ? t.totalDistanceKm.toFixed(2) + ' km' : '0.00 km';
    document.getElementById('tripDur').textContent = t.durationMinutes ? t.durationMinutes + ' min' : '‚Äî';
    const st = document.getElementById('tripStatus');
    st.innerHTML = t.status === 'COMPLETED'
        ? '<span class="badge b-completed">‚úì Completed</span>'
        : '<span class="badge b-progress">‚óè In Progress</span>';
}

function updateDriverInfo(data) {
    if (!data.trips.length) return;
    const t = data.trips[0];
    document.getElementById('driverName').textContent  = t.driverName  || '‚Äî';
    document.getElementById('driverPhone').textContent = t.driverPhone || '‚Äî';
    document.getElementById('driverLic').textContent   = t.driverLicense || '‚Äî';
}

function updatePickupInfo(data) {
    if (!data.pickupPoints.length) return;
    const pp = data.pickupPoints[0];
    document.getElementById('pickupCoords').textContent = pp.latitude.toFixed(4) + ', ' + pp.longitude.toFixed(4);
    document.getElementById('pickupRadius').textContent = pp.radiusMeters + 'm';
    const st = document.getElementById('pickupStatus');
    st.innerHTML = pp.status === 'ARRIVED'
        ? '<span class="badge b-arrived">‚úì Arrived</span>'
        : '<span class="badge b-pending">‚óè Pending</span>';
}

function updateStats(data) {
    document.getElementById('statPings').textContent  = data.locationLogs.length;
    document.getElementById('statEvents').textContent = data.events.length;
    if (!wsConnected && data.locationLogs.length > 0) {
        const ll = data.locationLogs[data.locationLogs.length - 1];
        document.getElementById('statSpeed').textContent = ll.speed.toFixed(0);
        document.getElementById('statDist').textContent  = (data.trips[0]?.totalDistanceKm || 0).toFixed(2);
    }
    // ETA (Functionality #6)
    if (data.trips.length > 0) {
        const t = data.trips[0];
        if (t.etaMinutes !== null && t.etaMinutes !== undefined && t.status === 'IN_PROGRESS') {
            document.getElementById('statEta').textContent = t.etaMinutes + ' min ‚Üí ' + (t.etaDestination || '');
        } else if (t.status === 'COMPLETED') {
            document.getElementById('statEta').textContent = 'Arrived ‚úì';
        } else {
            document.getElementById('statEta').textContent = '‚Äî';
        }
    }
}

// ===========================
// Map static elements (geofences, markers) ‚Äî drawn once
// ===========================
function updateMapStaticElements(data) {
    if (data.pickupPoints.length > 0 && !pickupCircle) {
        const pp = data.pickupPoints[0];
        pickupCircle = L.circle([pp.latitude, pp.longitude], {
            radius: pp.radiusMeters, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.12, weight: 2, dashArray: '6,4'
        }).addTo(map);
        pickupMarker = L.marker([pp.latitude, pp.longitude], {
            icon: L.divIcon({ html: '<div style="font-size:20px">üìç</div>', className: 'emoji-lbl', iconSize: [28,28], iconAnchor: [14,14] })
        }).addTo(map).bindPopup('<b>Pickup Point</b><br>Radius: ' + pp.radiusMeters + 'm');
    }
    if (data.officeGeofences.length > 0 && !officeCircle) {
        const of = data.officeGeofences[0];
        officeCircle = L.circle([of.latitude, of.longitude], {
            radius: of.radiusMeters, color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.12, weight: 2, dashArray: '6,4'
        }).addTo(map);
        officeMarker = L.marker([of.latitude, of.longitude], {
            icon: L.divIcon({ html: '<div style="font-size:20px">üè¢</div>', className: 'emoji-lbl', iconSize: [28,28], iconAnchor: [14,14] })
        }).addTo(map).bindPopup('<b>Office</b><br>Radius: ' + of.radiusMeters + 'm');
    }
    // Rebuild route from DB (useful after page reload or fallback to polling)
    if (!wsConnected && data.locationLogs.length > 0) {
        const pts = data.locationLogs.map(l => [l.latitude, l.longitude]);
        routePoints = pts;
        if (routeLine) routeLine.setLatLngs(pts);
        else routeLine = L.polyline(pts, { color: '#f59e0b', weight: 3.5, opacity: 0.85 }).addTo(map);
        const ll = data.locationLogs[data.locationLogs.length - 1];
        if (!vehicleMarker) {
            vehicleMarker = L.marker([ll.latitude, ll.longitude], {
                icon: L.divIcon({ html: '<div class="vehicle-marker">üöê</div>', className: '', iconSize: [36,36], iconAnchor: [18,18] }),
                zIndexOffset: 1000
            }).addTo(map);
        }
        vehicleMarker.setLatLng([ll.latitude, ll.longitude]);
    }
}

// ===========================
// Events (Functionality #7 + #8)
// ===========================
const EVENT_META = {
    PICKUP_ARRIVED: { icon: 'üìç', cls: 'pickup',   label: 'Pickup Arrived'  },
    OFFICE_REACHED: { icon: 'üè¢', cls: 'office',   label: 'Office Reached'  },
    TRIP_COMPLETED: { icon: '‚úÖ', cls: 'complete',  label: 'Trip Completed'  }
};

function updateEvents(data) {
    const list = document.getElementById('eventList');
    if (!data.events.length) {
        list.innerHTML = '<li class="list-empty">No events yet. Run a simulation!</li>';
        return;
    }
    list.innerHTML = data.events.map(e => {
        const m = EVENT_META[e.eventType] || { icon: '‚ö°', cls: '', label: e.eventType };
        return `<li class="ev-item ${m.cls}">
            <span class="ev-icon">${m.icon}</span>
            <div><div class="ev-title">${m.label}</div><div class="ev-sub">${fmt(e.timestamp)} ¬∑ Trip #${e.tripId}</div></div>
        </li>`;
    }).join('');

    // Toast for new events
    if (data.events.length > previousEventCount && previousEventCount > 0) {
        const newOnes = data.events.slice(0, data.events.length - previousEventCount);
        newOnes.forEach(e => {
            const m = EVENT_META[e.eventType] || { icon: '‚ö°' };
            toast(m.icon + ' ' + (EVENT_META[e.eventType]?.label || e.eventType), 'info');
        });
    }
    previousEventCount = data.events.length;
}

// ===========================
// Notification Feed (Functionality #5 ‚Äî simulated push/SMS)
// Displayed when PICKUP_ARRIVED or TRIP_COMPLETED fires
// ===========================
let notifHistory = [];
function updateNotifications(data) {
    const list = document.getElementById('notifList');
    const notifications = data.events.filter(e => e.eventType === 'PICKUP_ARRIVED' || e.eventType === 'TRIP_COMPLETED');

    // Check for new ones and add to history
    notifications.forEach(e => {
        const key = e.id + '_' + e.eventType;
        if (!notifHistory.includes(key)) {
            notifHistory.push(key);
        }
    });

    if (!notifications.length) {
        list.innerHTML = '<li class="list-empty">Notifications will appear here‚Ä¶</li>';
        return;
    }

    list.innerHTML = notifications.map(e => {
        const isPickup = e.eventType === 'PICKUP_ARRIVED';
        return `<li class="ev-item notif">
            <span class="ev-icon">üì±</span>
            <div>
                <div class="ev-title">${isPickup ? 'Push: Cab has arrived!' : 'Push: Trip completed!'}</div>
                <div class="ev-sub">${isPickup ? 'üì≤ SMS fallback sent to employee' : 'üì≤ SMS fallback sent'} ¬∑ ${fmt(e.timestamp)}</div>
            </div>
        </li>`;
    }).join('');
}

// ===========================
// Simulation helpers
// ===========================
async function sendPing(lat, lng, speed) {
    const res = await fetch('/api/location/update', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicleId: 1, tripId: 1, latitude: lat, longitude: lng, speed: speed,
            timestamp: new Date().toISOString().slice(0, 19) })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message || 'API error'); }
}

function setSimulating(active, msg) {
    isSimulating = active;
    document.getElementById('simStatus').textContent = msg || (active ? 'Simulating‚Ä¶' : 'Ready to simulate');
    document.getElementById('simStatus').className = 'sim-status' + (active ? ' active' : '');
    document.querySelectorAll('.sim-btn').forEach(b => b.disabled = active);
}

const sleep = ms => new Promise(r => setTimeout(r, ms));

async function simulatePickup() {
    try {
        setSimulating(true, 'üìç Sending pickup ping‚Ä¶');
        await sendPing(12.9520, 77.5750, 2);
        await sleep(600); await refreshDashboard();
        setSimulating(false, '‚úì Pickup ping sent!');
        toast('üìç Ping sent at pickup location (inside 50m geofence)', 'info');
    } catch (e) { setSimulating(false, '‚úó ' + e.message); toast('Error: ' + e.message, 'error'); }
}

async function simulateDrive() {
    // If road route not loaded yet, fetch it first
    if (roadRouteWaypoints.length === 0) {
        toast('üó∫Ô∏è Fetching road route first‚Ä¶', 'info');
        const ok = await loadRoadRoute(true); // silent=true (don't set simulating state from inside)
        if (!ok) return;
    }

    // Build evenly-spaced speed profile across the route
    const n = roadRouteWaypoints.length;
    const speeds = roadRouteWaypoints.map((_, i) => {
        const t = i / (n - 1);   // 0‚Üí1 along the route
        // Ramp up 0‚Üí0.3, cruise 0.3‚Üí0.8, ramp down 0.8‚Üí1
        if (t < 0.3)      return Math.round(5  + t / 0.3 * 35);    // 5‚Üí40
        else if (t < 0.8) return Math.round(38 + Math.sin(t * Math.PI) * 6); // 38-44
        else              return Math.round(40 - (t - 0.8) / 0.2 * 35);       // 40‚Üí5
    });

    try {
        setSimulating(true, 'üöó Driving along road route‚Ä¶');
        for (let i = 0; i < n; i++) {
            const [lat, lng] = roadRouteWaypoints[i];
            const spd = speeds[i];
            setSimulating(true, `üöó Driving‚Ä¶ (${i+1}/${n}) ‚Äî ${spd} km/h`);
            await sendPing(lat, lng, spd);
            // Move vehicle marker immediately on map (smooth visual)
            if (vehicleMarker) vehicleMarker.setLatLng([lat, lng]);
            await sleep(400);
            // Only refresh dashboard every ~3 pings to reduce load
            if (i % 3 === 0 || i === n - 1) await refreshDashboard();
        }
        setSimulating(false, '‚úì Arrived near office!');
        toast('üöó Road route simulation complete ‚Äî near office', 'warn');
    } catch (e) { setSimulating(false, '‚úó ' + e.message); toast('Error: ' + e.message, 'error'); }
}

// ===========================
// OSRM Road Route (Functionality: real road path)
// Fetches actual road geometry from pickup ‚Üí office via OSRM
// Draws a highlighted dashed purple polyline on the map
// ===========================
async function loadRoadRoute(silent = false) {
    // Pickup: 12.9520, 77.5750  ‚Üí  Office: 12.9716, 77.5946
    const from = [12.9520, 77.5750];
    const to   = [12.9716, 77.5946];

    if (!silent) setSimulating(true, 'üó∫Ô∏è Loading road route from OSRM‚Ä¶');

    try {
        // OSRM public demo API ‚Äî no key required
        const url = `https://router.project-osrm.org/route/v1/driving/` +
                    `${from[1]},${from[0]};${to[1]},${to[0]}` +
                    `?overview=full&geometries=geojson`;

        const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
        if (!res.ok) throw new Error('OSRM API error: ' + res.status);
        const json = await res.json();

        if (!json.routes || json.routes.length === 0) throw new Error('No route found');

        // GeoJSON coords are [lng, lat] ‚Üí convert to Leaflet [lat, lng]
        const coords = json.routes[0].geometry.coordinates;
        roadRouteWaypoints = coords.map(c => [c[1], c[0]]);

        // Draw / update the road route layer
        if (roadRouteLayer) map.removeLayer(roadRouteLayer);
        roadRouteLayer = L.polyline(roadRouteWaypoints, {
            color: '#a855f7',
            weight: 5,
            opacity: 0.75,
            dashArray: '10, 6',
            lineJoin: 'round'
        }).addTo(map);

        // Fit map to show the full route
        map.fitBounds(roadRouteLayer.getBounds(), { padding: [40, 40] });

        const distKm = (json.routes[0].distance / 1000).toFixed(2);
        const durMin = Math.round(json.routes[0].duration / 60);

        if (!silent) {
            setSimulating(false, `‚úì Road route loaded (${distKm} km, ~${durMin} min)`);
            toast(`üó∫Ô∏è Road route loaded ‚Äî ${distKm} km ¬∑ ${roadRouteWaypoints.length} waypoints`, 'success');
        }
        return true;
    } catch (e) {
        if (!silent) setSimulating(false, '‚úó OSRM error: ' + e.message);
        toast('‚ö†Ô∏è OSRM unavailable ‚Äî using fallback straight path', 'warn');

        // Fallback: straight-line interpolation between key waypoints
        roadRouteWaypoints = interpolatePath([
            [12.9520, 77.5750],
            [12.9580, 77.5810],
            [12.9640, 77.5875],
            [12.9716, 77.5946]
        ], 20);

        if (roadRouteLayer) map.removeLayer(roadRouteLayer);
        roadRouteLayer = L.polyline(roadRouteWaypoints, {
            color: '#a855f7', weight: 5, opacity: 0.65,
            dashArray: '8, 5', lineJoin: 'round'
        }).addTo(map);
        map.fitBounds(roadRouteLayer.getBounds(), { padding: [40, 40] });

        if (!silent) toast(`üó∫Ô∏è Fallback path drawn (${roadRouteWaypoints.length} pts)`, 'info');
        return true;
    }
}

// Linear interpolation between path keypoints ‚Üí n points per segment
function interpolatePath(keypoints, pointsPerSegment) {
    const result = [];
    for (let s = 0; s < keypoints.length - 1; s++) {
        const [lat1, lng1] = keypoints[s];
        const [lat2, lng2] = keypoints[s + 1];
        for (let i = 0; i <= pointsPerSegment; i++) {
            const t = i / pointsPerSegment;
            result.push([lat1 + (lat2 - lat1) * t, lng1 + (lng2 - lng1) * t]);
        }
    }
    return result;
}

async function simulateOffice() {
    try {
        setSimulating(true, 'üè¢ Arriving at office (speed 2 km/h)‚Ä¶');
        await sendPing(12.9716, 77.5946, 2);
        await sleep(600); await refreshDashboard();
        setSimulating(false, '‚úì Office arrival ping sent!');
        toast('üè¢ At office ‚Äî speed < 5 km/h ‚Üí TRIP_COMPLETED!', 'success');
    } catch (e) { setSimulating(false, '‚úó ' + e.message); toast('Error: ' + e.message, 'error'); }
}

async function resetTrip() {
    try {
        setSimulating(true, 'üîÑ Resetting‚Ä¶');
        const res = await fetch('/api/dashboard/reset', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            if (vehicleMarker) { map.removeLayer(vehicleMarker); vehicleMarker = null; }
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            if (roadRouteLayer) { map.removeLayer(roadRouteLayer); roadRouteLayer = null; }
            routePoints = []; roadRouteWaypoints = [];
            previousEventCount = 0; notifHistory = [];
            await refreshDashboard();
            setSimulating(false, '‚úì Reset! Ready to simulate again.');
            toast('üîÑ Trip has been reset', 'warn');
        } else throw new Error(data.message);
    } catch (e) { setSimulating(false, '‚úó ' + e.message); toast('Error: ' + e.message, 'error'); }
}

// ===========================
// Boot
// ===========================
initMap();
connectWebSocket();                                    // WebSocket first
refreshDashboard();                                    // Initial data load
pollInterval = setInterval(() => {                     // Polling every 4s for status/events
    if (!isSimulating) refreshDashboard();
}, 4000);
</script>
</body>
</html> 



