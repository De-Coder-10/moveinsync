<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoveInSync ‚Äî Operations Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --green:        #00A651;
            --green-dark:   #007A3D;
            --green-darker: #005C2E;
            --green-light:  #E8F5EE;
            --green-mid:    #B8DFC8;
            --green-accent: #00C85A;
            --bg:           #F0F6F2;
            --white:        #FFFFFF;
            --card:         #FFFFFF;
            --text:         #1C2E1C;
            --text-2:       #4A6050;
            --text-3:       #7A9080;
            --border:       #D4E8DC;
            --shadow:       0 2px 12px rgba(0,100,50,0.07);
            --shadow-md:    0 4px 20px rgba(0,100,50,0.12);
            --shadow-lg:    0 8px 32px rgba(0,100,50,0.16);
            --radius:       12px;
            --radius-sm:    8px;
            --warn:         #F59E0B;
            --danger:       #EF4444;
            --info:         #3B82F6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--green-darker) 0%, var(--green-dark) 55%, var(--green) 100%);
            height: 62px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 3px 20px rgba(0,100,50,0.35);
            position: relative;
            z-index: 1000;
            flex-shrink: 0;
        }
        .header-left  { display: flex; align-items: center; gap: 16px; }
        .header-right { display: flex; align-items: center; gap: 14px; }

        .mis-logo { display: flex; align-items: center; gap: 10px; }
        .mis-logo-icon {
            width: 38px; height: 38px;
            background: rgba(255,255,255,0.15);
            border: 1.5px solid rgba(255,255,255,0.25);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        .mis-brand   { font-size: 17px; font-weight: 800; color: #fff; letter-spacing: -0.3px; line-height: 1.1; }
        .mis-sub     { font-size: 10px; font-weight: 400; color: rgba(255,255,255,0.65); letter-spacing: 0.8px; text-transform: uppercase; }

        .hdr-divider { width: 1px; height: 28px; background: rgba(255,255,255,0.2); }
        .hdr-page    { font-size: 13px; font-weight: 500; color: rgba(255,255,255,0.85); }

        .live-clock  { font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.8); font-variant-numeric: tabular-nums; }

        .conn-badge {
            display: flex; align-items: center; gap: 6px;
            padding: 5px 13px; border-radius: 20px;
            font-size: 11px; font-weight: 700; letter-spacing: 0.3px;
        }
        .conn-ws   { background: rgba(255,255,255,0.15); color: #AFFFCC; border: 1px solid rgba(255,255,255,0.2); }
        .conn-poll { background: rgba(245,158,11,0.2);   color: #FCD34D; border: 1px solid rgba(245,158,11,0.3); }
        .conn-disc { background: rgba(239,68,68,0.2);    color: #FCA5A5; border: 1px solid rgba(239,68,68,0.3); }

        .pulse { width: 7px; height: 7px; border-radius: 50%; background: currentColor; animation: pulse 1.5s infinite; flex-shrink: 0; }
        @keyframes pulse { 0%,100% { opacity:1; transform:scale(1); } 50% { opacity:0.4; transform:scale(0.8); } }

        /* ===== APP BODY ===== */
        .app-body { height: calc(100vh - 62px); display: flex; flex-direction: column; }

        /* ===== KPI STRIP ===== */
        .kpi-strip {
            display: grid; grid-template-columns: repeat(4,1fr);
            gap: 10px; padding: 10px 18px;
            background: var(--white);
            border-bottom: 2px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,100,50,0.06);
            flex-shrink: 0;
        }
        .kpi-card {
            display: flex; align-items: center; gap: 12px;
            padding: 11px 14px;
            background: var(--white);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform .2s, box-shadow .2s;
            cursor: default;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kpi-icon {
            width: 44px; height: 44px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; flex-shrink: 0;
        }
        .kpi-icon.green  { background: var(--green-light); }
        .kpi-icon.amber  { background: #FEF9EC; }
        .kpi-icon.blue   { background: #EFF6FF; }
        .kpi-icon.red    { background: #FEF2F2; }
        .kpi-val  { font-size: 26px; font-weight: 800; line-height: 1; }
        .kpi-val.green { color: var(--green-dark); }
        .kpi-val.amber { color: #D97706; }
        .kpi-val.blue  { color: #1D4ED8; }
        .kpi-val.red   { color: #DC2626; }
        .kpi-lbl  { font-size: 10px; font-weight: 500; color: var(--text-3); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.4px; }
        .kpi-pill {
            font-size: 10px; font-weight: 700; padding: 3px 9px; border-radius: 12px;
            white-space: nowrap; flex-shrink: 0; margin-left: auto;
        }
        .pill-green { background: var(--green-light); color: var(--green-dark); }
        .pill-amber { background: #FEF9EC; color: #B45309; }
        .pill-grey  { background: #F3F4F6; color: #6B7280; }
        .pill-red   { background: #FEF2F2; color: #DC2626; }

        /* ===== MAIN ===== */
        .main-content { display: flex; flex: 1; overflow: hidden; }

        /* ===== MAP ===== */
        .map-wrapper { flex: 1; position: relative; overflow: hidden; }
        #map { width: 100%; height: 100%; }

        .map-top-bar {
            position: absolute; top: 12px; left: 12px; right: 12px;
            z-index: 999; display: flex; gap: 8px; pointer-events: none;
        }
        .map-pill {
            background: var(--white); border: 1.5px solid var(--border);
            border-radius: 20px; padding: 5px 14px; font-size: 11px; font-weight: 600;
            color: var(--text); display: flex; align-items: center; gap: 6px;
            box-shadow: var(--shadow); pointer-events: auto;
        }
        .map-pill .dot { width: 8px; height: 8px; border-radius: 50%; }

        .map-legend {
            position: absolute; bottom: 30px; left: 12px;
            background: var(--white); border: 1.5px solid var(--border);
            border-radius: var(--radius); padding: 12px 16px;
            z-index: 999; font-size: 11px; box-shadow: var(--shadow-md); min-width: 160px;
        }
        .map-legend h4 { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-3); margin-bottom: 8px; }
        .leg-item { display: flex; align-items: center; gap: 8px; padding: 3px 0; color: var(--text-2); font-size: 11px; }
        .leg-dot  { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .leg-line { width: 18px; height: 3px; border-radius: 2px; flex-shrink: 0; }

        /* ===== RIGHT PANEL ===== */
        .right-panel {
            width: 345px; min-width: 345px;
            background: var(--bg);
            border-left: 2px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .cmd-header {
            background: var(--white); border-bottom: 1.5px solid var(--border);
            padding: 10px 16px; flex-shrink: 0;
            display: flex; align-items: center; gap: 10px;
        }
        .cmd-title { font-size: 13px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .live-dot  { width: 9px; height: 9px; border-radius: 50%; background: var(--green); animation: pulse 1.5s infinite; }

        /* Tabs */
        .tabs { display: flex; background: var(--white); border-bottom: 2px solid var(--border); flex-shrink: 0; }
        .tab {
            flex: 1; padding: 10px 4px; font-size: 11px; font-weight: 600;
            color: var(--text-3); text-align: center; cursor: pointer;
            border-bottom: 2.5px solid transparent; margin-bottom: -2px;
            transition: color .2s, border-color .2s;
            text-transform: uppercase; letter-spacing: 0.4px;
        }
        .tab.active  { color: var(--green-dark); border-bottom-color: var(--green); }
        .tab:hover:not(.active) { color: var(--green); }

        .panel-body {
            flex: 1; overflow-y: auto; padding: 12px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .panel-body::-webkit-scrollbar { width: 5px; }
        .panel-body::-webkit-scrollbar-thumb { background: var(--green-mid); border-radius: 3px; }

        /* ===== CARDS ===== */
        .card { background: var(--card); border: 1.5px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .card-hdr {
            padding: 10px 14px; background: var(--green-light);
            border-bottom: 1.5px solid var(--green-mid);
            display: flex; align-items: center; gap: 8px;
        }
        .card-hdr-icon  { font-size: 14px; }
        .card-hdr-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--green-dark); flex: 1; }
        .card-hdr-badge { font-size: 10px; font-weight: 700; padding: 2px 9px; background: var(--green); color: #fff; border-radius: 12px; }
        .card-body { padding: 12px 14px; }

        /* Info rows */
        .row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(0,166,81,0.07); font-size: 12px; }
        .row:last-child { border-bottom: none; }
        .row .lbl { color: var(--text-3); font-weight: 500; }
        .row .val { font-weight: 600; color: var(--text); text-align: right; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 9px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; }
        .b-live      { background: var(--green-light); color: var(--green-dark); border: 1px solid var(--green-mid); }
        .b-done      { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
        .b-pending   { background: #F3F4F6; color: #6B7280; border: 1px solid #E5E7EB; }
        .b-arrived   { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
        .b-progress  { background: #FEF9EC; color: #D97706; border: 1px solid #FCD34D; }
        .b-completed { background: var(--green-light); color: var(--green-dark); border: 1px solid var(--green-mid); }
        .b-alert     { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-box {
            background: var(--green-light); border-radius: var(--radius-sm);
            padding: 10px 12px; text-align: center; border: 1.5px solid var(--green-mid);
        }
        .stat-box.full { grid-column: span 2; }
        .stat-box.hi   { background: var(--green); border-color: var(--green-dark); }
        .stat-val  { font-size: 20px; font-weight: 800; color: var(--green-dark); }
        .stat-lbl  { font-size: 9px; color: var(--text-3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        .stat-box.hi .stat-val { color: #fff; }
        .stat-box.hi .stat-lbl { color: rgba(255,255,255,0.75); }

        /* Filter chips */
        .filter-row { display: flex; gap: 6px; flex-wrap: wrap; }
        .chip {
            padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 700;
            cursor: pointer; border: 1.5px solid var(--border); background: var(--white);
            color: var(--text-2); transition: all .2s; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .chip.active { background: var(--green); color: #fff; border-color: var(--green-dark); }
        .chip:hover:not(.active) { background: var(--green-light); border-color: var(--green-mid); color: var(--green-dark); }

        .flt-select {
            flex: 1; padding: 6px 10px; border: 1.5px solid var(--border);
            border-radius: var(--radius-sm); background: var(--white);
            font-size: 11px; color: var(--text); font-family: inherit;
            font-weight: 500; outline: none; cursor: pointer;
            transition: border-color .2s;
        }
        .flt-select:focus { border-color: var(--green); box-shadow: 0 0 0 3px rgba(0,166,81,0.1); }

        /* Vehicle cards */
        .v-card {
            background: var(--white); border: 1.5px solid var(--border);
            border-radius: var(--radius); padding: 12px;
            display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: all .2s; box-shadow: var(--shadow);
        }
        .v-card:hover   { border-color: var(--green-mid); box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .v-card.sel     { border-color: var(--green); background: var(--green-light); }
        .v-avatar       { width: 42px; height: 42px; border-radius: 10px; background: var(--green); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .v-info         { flex: 1; min-width: 0; }
        .v-reg          { font-size: 13px; font-weight: 700; color: var(--text); }
        .v-driver       { font-size: 11px; color: var(--text-2); margin-top: 2px; }
        .v-chips        { display: flex; gap: 5px; margin-top: 5px; }
        .v-chip         { font-size: 10px; padding: 2px 7px; border-radius: 10px; font-weight: 700; }
        .vc-spd         { background: #EFF6FF; color: #1D4ED8; }
        .vc-eta         { background: var(--green-light); color: var(--green-dark); }

        /* Event / Notification feed */
        .ev-list { list-style: none; display: flex; flex-direction: column; gap: 6px; }
        .ev-item {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 12px; background: var(--white);
            border-radius: var(--radius-sm); border: 1.5px solid var(--border);
            font-size: 11px; transition: all .2s; animation: slideIn .3s ease;
        }
        .ev-item:hover { border-color: var(--green-mid); box-shadow: var(--shadow); }
        .ev-item.pickup   { border-left: 3px solid #3B82F6; }
        .ev-item.office   { border-left: 3px solid var(--green); }
        .ev-item.complete { border-left: 3px solid var(--green-dark); }
        .ev-item.notif    { border-left: 3px solid var(--warn); }
        .ev-item.alert    { border-left: 3px solid var(--danger); }
        .ev-icon-w {
            width: 30px; height: 30px; border-radius: 7px;
            display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0;
        }
        .ic-green { background: var(--green-light); }
        .ic-blue  { background: #EFF6FF; }
        .ic-amber { background: #FEF9EC; }
        .ic-red   { background: #FEF2F2; }
        .ev-title { font-weight: 700; color: var(--text); }
        .ev-sub   { color: var(--text-3); font-size: 10px; margin-top: 2px; }
        .empty-msg { text-align: center; color: var(--text-3); font-size: 12px; padding: 22px; font-style: italic; }

        @keyframes slideIn { from { opacity:0; transform:translateX(10px); } to { opacity:1; transform:translateX(0); } }

        /* Section header */
        .sec-hdr {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; color: var(--text-3);
            padding: 2px 0; display: flex; align-items: center; gap: 8px;
        }
        .sec-hdr::after { content:''; flex:1; height:1px; background:var(--border); }

        /* Sim buttons */
        .sim-btns { display: flex; flex-direction: column; gap: 6px; }
        .sim-btn {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            border: 1.5px solid var(--border); border-radius: var(--radius-sm);
            background: var(--white); color: var(--text); font-size: 12px;
            font-weight: 600; cursor: pointer; transition: all .2s; font-family: inherit; text-align: left;
        }
        .sim-btn:hover:not(:disabled) { border-color: var(--green-mid); background: var(--green-light); color: var(--green-dark); transform: translateY(-1px); box-shadow: var(--shadow); }
        .sim-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }
        .sim-ico { width: 28px; height: 28px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .btn-route  .sim-ico { background: #F3E8FF; }
        .btn-pickup .sim-ico { background: #EFF6FF; }
        .btn-drive  .sim-ico { background: #FEF9EC; }
        .btn-office .sim-ico { background: var(--green-light); }
        .btn-reset  .sim-ico { background: #FEF2F2; }

        .sim-bar {
            padding: 8px 12px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;
            text-align: center; background: var(--green-light); color: var(--green-dark);
            border: 1.5px solid var(--green-mid); min-height: 34px;
            display: flex; align-items: center; justify-content: center; transition: all .3s;
        }
        .sim-bar.running { background: #FEF9EC; color: #D97706; border-color: #FCD34D; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0%,100%{opacity:1} 50%{opacity:.65} }

        /* Speed gauge */
        .spd-num  { font-size: 36px; font-weight: 800; color: var(--green-dark); line-height: 1; }
        .spd-unit { font-size: 11px; color: var(--text-3); font-weight: 500; }
        .spd-bar-wrap { flex: 1; height: 7px; background: var(--green-light); border-radius: 4px; overflow: hidden; }
        .spd-bar { height: 100%; background: linear-gradient(90deg, var(--green), var(--green-accent)); border-radius: 4px; transition: width .5s ease; }

        /* Driver avatar */
        .drv-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--green-dark), var(--green)); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; border: 2.5px solid var(--green-mid); }

        /* Toasts */
        .toast-wrap { position: fixed; top: 72px; right: 18px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; max-width: 320px; }
        .toast {
            padding: 11px 18px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600;
            color: white; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 8px;
            animation: tIn .3s ease, tOut .35s ease 3.65s forwards; border-left: 4px solid rgba(255,255,255,0.3);
        }
        .t-success { background: var(--green-dark); }
        .t-info    { background: #2563EB; }
        .t-warn    { background: #D97706; }
        .t-error   { background: #DC2626; }
        @keyframes tIn  { from{opacity:0;transform:translateX(30px)} to{opacity:1;transform:translateX(0)} }
        @keyframes tOut { from{opacity:1} to{opacity:0;transform:translateY(-10px)} }

        /* Leaflet overrides */
        .vehicle-marker { font-size: 28px; filter: drop-shadow(0 3px 8px rgba(0,100,50,0.5)); }
        .emoji-lbl { background: none !important; border: none !important; font-size: 22px; }
        .leaflet-popup-content-wrapper { background: var(--white); color: var(--text); border: 1.5px solid var(--border); border-radius: 10px; box-shadow: var(--shadow-md); }
        .leaflet-popup-tip { background: var(--white); }
        .leaflet-popup-content { font-size: 12px; font-family: 'Inter', sans-serif; line-height: 1.6; }
        .popup-title { font-weight: 700; font-size: 13px; color: var(--green-dark); margin-bottom: 6px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
        .popup-row { display: flex; justify-content: space-between; gap: 14px; font-size: 11px; padding: 2px 0; }
        .popup-row .pl { color: var(--text-3); }
        .popup-row .pv { font-weight: 700; color: var(--text); }

        /* Scrollbar */
        * { scrollbar-width: thin; scrollbar-color: var(--green-mid) transparent; }
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="header">
    <div class="header-left">
        <div class="mis-logo">
            <div class="mis-logo-icon">üöê</div>
            <div>
                <div class="mis-brand">MoveInSync</div>
                <div class="mis-sub">Operations Centre</div>
            </div>
        </div>
        <div class="hdr-divider"></div>
        <span class="hdr-page">Real-Time Tracking Dashboard</span>
    </div>
    <div class="header-right">
        <span class="live-clock" id="liveClock">--:--:-- IST</span>
        <span id="connBadge" class="conn-badge conn-disc"><span class="pulse"></span> Connecting‚Ä¶</span>
    </div>
</header>

<div class="app-body">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê KPI STRIP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="kpi-strip">
        <div class="kpi-card">
            <div class="kpi-icon green">üöê</div>
            <div style="flex:1">
                <div class="kpi-val green" id="kpiOngoing">0</div>
                <div class="kpi-lbl">Ongoing Trips</div>
            </div>
            <span class="kpi-pill pill-green" id="kpiOngoingPill">Idle</span>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon amber">‚ö†Ô∏è</div>
            <div style="flex:1">
                <div class="kpi-val amber" id="kpiDelayed">0</div>
                <div class="kpi-lbl">Delayed Trips</div>
            </div>
            <span class="kpi-pill pill-grey" id="kpiDelayedPill">SLA</span>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon blue">üè¢</div>
            <div style="flex:1">
                <div class="kpi-val blue" id="kpiInGeo">0</div>
                <div class="kpi-lbl">In Office Geofence</div>
            </div>
            <span class="kpi-pill pill-grey" id="kpiInGeoPill">‚Äî</span>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon red">üìç</div>
            <div style="flex:1">
                <div class="kpi-val red" id="kpiNearPU">0</div>
                <div class="kpi-lbl">Near Pickup</div>
            </div>
            <span class="kpi-pill pill-grey" id="kpiNearPUPill">‚Äî</span>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="main-content">

        <!-- MAP -->
        <div class="map-wrapper">
            <div class="map-top-bar">
                <div class="map-pill"><span class="dot" style="background:var(--green);width:8px;height:8px;border-radius:50%;animation:pulse 1.5s infinite"></span> Live Tracking</div>
                <div class="map-pill" id="mapVehiclePill" style="display:none">üöê <span id="mapVehicleInfo">‚Äî</span></div>
            </div>
            <div id="map"></div>
            <div class="map-legend">
                <h4>Map Legend</h4>
                <div class="leg-item"><span class="leg-dot" style="background:rgba(59,130,246,.25);border:2px solid #3B82F6"></span>Pickup Zone</div>
                <div class="leg-item"><span class="leg-dot" style="background:rgba(0,166,81,.25);border:2px solid var(--green)"></span>Office Zone</div>
                <div class="leg-item"><span class="leg-line" style="border-top:2px dashed #A855F7"></span>Road Route</div>
                <div class="leg-item"><span class="leg-line" style="background:#F59E0B"></span>Route Trail</div>
                <div class="leg-item">üöê Live Vehicle</div>
            </div>
        </div>

        <!-- RIGHT PANEL: COMMAND CENTER -->
        <div class="right-panel">

            <div class="cmd-header">
                <span class="live-dot"></span>
                <div class="cmd-title">Command Center Monitoring</div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('monitor',this)">Monitor</div>
                <div class="tab" onclick="switchTab('trip',this)">Trip</div>
                <div class="tab" onclick="switchTab('events',this)">Events</div>
                <div class="tab" onclick="switchTab('sim',this)">Simulate</div>
            </div>

            <!-- ‚îÄ‚îÄ TAB: MONITOR ‚îÄ‚îÄ -->
            <div class="panel-body" id="tab-monitor">

                <!-- Filters -->
                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üîç</span>
                        <span class="card-hdr-title">Filters</span>
                    </div>
                    <div class="card-body" style="display:flex;flex-direction:column;gap:8px">
                        <div style="display:flex;gap:6px">
                            <select class="flt-select" id="fltRegion" onchange="applyFilters()">
                                <option value="">üåè All Regions</option>
                                <option value="bangalore">Bangalore</option>
                                <option value="pune">Pune</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="hyderabad">Hyderabad</option>
                            </select>
                            <select class="flt-select" id="fltOffice" onchange="applyFilters()">
                                <option value="">üè¢ All Offices</option>
                                <option value="hq">Bangalore HQ</option>
                                <option value="itpark">IT Park</option>
                                <option value="techhub">Tech Hub</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:6px">
                            <select class="flt-select" id="fltRoute" onchange="applyFilters()">
                                <option value="">üõ£Ô∏è All Routes</option>
                                <option value="north">North Route</option>
                                <option value="south">South Route</option>
                                <option value="east">East Route</option>
                            </select>
                            <select class="flt-select" id="fltTime" onchange="applyFilters()">
                                <option value="">‚è∞ All Time</option>
                                <option value="morning">Morning 6‚Äì10</option>
                                <option value="evening">Evening 4‚Äì9</option>
                                <option value="now">Right Now</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <span class="chip active" onclick="setStatusFilter(this,'all')">All</span>
                            <span class="chip" onclick="setStatusFilter(this,'active')">Active</span>
                            <span class="chip" onclick="setStatusFilter(this,'delayed')">Delayed</span>
                            <span class="chip" onclick="setStatusFilter(this,'done')">Done</span>
                        </div>
                    </div>
                </div>

                <!-- Live Stats -->
                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üìä</span>
                        <span class="card-hdr-title">Live Metrics</span>
                        <span style="width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;margin-left:auto"></span>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-box"><div class="stat-val" id="statPings">0</div><div class="stat-lbl">GPS Pings</div></div>
                            <div class="stat-box"><div class="stat-val" id="statEvents">0</div><div class="stat-lbl">Events</div></div>
                            <div class="stat-box hi"><div class="stat-val" id="statSpeed">‚Äî</div><div class="stat-lbl">Speed km/h</div></div>
                            <div class="stat-box"><div class="stat-val" id="statDist">0</div><div class="stat-lbl">Distance km</div></div>
                            <div class="stat-box full"><div class="stat-val" style="font-size:15px" id="statEta">‚Äî</div><div class="stat-lbl">ETA to Next Stop</div></div>
                        </div>
                    </div>
                </div>

                <!-- Active Vehicles -->
                <div class="sec-hdr">Active Vehicles</div>
                <div id="vehiclesList"><div class="empty-msg">Loading vehicles‚Ä¶</div></div>

            </div>

            <!-- ‚îÄ‚îÄ TAB: TRIP ‚îÄ‚îÄ -->
            <div class="panel-body" id="tab-trip" style="display:none">

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üó∫Ô∏è</span>
                        <span class="card-hdr-title">Trip Information</span>
                        <span class="card-hdr-badge" id="tripStatusBadge" style="background:var(--warn)">‚Äî</span>
                    </div>
                    <div class="card-body">
                        <div class="row"><span class="lbl">Trip ID</span><span class="val" id="tripId">‚Äî</span></div>
                        <div class="row"><span class="lbl">Status</span><span id="tripStatus"><span class="badge b-pending">Loading</span></span></div>
                        <div class="row"><span class="lbl">Vehicle</span><span class="val" id="vehicleReg">‚Äî</span></div>
                        <div class="row"><span class="lbl">Started</span><span class="val" id="tripStart">‚Äî</span></div>
                        <div class="row"><span class="lbl">Ended</span><span class="val" id="tripEnd">‚Äî</span></div>
                        <div class="row"><span class="lbl">Distance</span><span class="val" id="tripDist">‚Äî</span></div>
                        <div class="row"><span class="lbl">Duration</span><span class="val" id="tripDur">‚Äî</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üë§</span>
                        <span class="card-hdr-title">Driver Details</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border)">
                            <div class="drv-avatar">üë§</div>
                            <div>
                                <div style="font-size:14px;font-weight:700;color:var(--text)" id="driverNameLg">‚Äî</div>
                                <div style="font-size:11px;color:var(--text-3);margin-top:3px" id="driverPhoneLg">‚Äî</div>
                                <div style="display:flex;gap:4px;margin-top:5px">
                                    <span style="font-size:13px;color:#F59E0B">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                </div>
                            </div>
                        </div>
                        <div class="row"><span class="lbl">License</span><span class="val" id="driverLic">‚Äî</span></div>
                        <div class="row"><span class="lbl">Status</span><span class="val" style="color:var(--green);font-weight:700">‚óè On Duty</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üìç</span>
                        <span class="card-hdr-title">Pickup Point</span>
                    </div>
                    <div class="card-body">
                        <div class="row"><span class="lbl">Status</span><span id="pickupStatus"><span class="badge b-pending">Pending</span></span></div>
                        <div class="row"><span class="lbl">Coordinates</span><span class="val" id="pickupCoords">‚Äî</span></div>
                        <div class="row"><span class="lbl">Geofence Radius</span><span class="val" id="pickupRadius">‚Äî</span></div>
                    </div>
                </div>

            </div>

            <!-- ‚îÄ‚îÄ TAB: EVENTS ‚îÄ‚îÄ -->
            <div class="panel-body" id="tab-events" style="display:none">

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üîî</span>
                        <span class="card-hdr-title">Push Notifications</span>
                        <span style="font-size:9px;color:var(--text-3);font-weight:500;margin-left:auto">Simulated</span>
                    </div>
                    <div class="card-body" style="padding:8px 10px">
                        <ul class="ev-list" id="notifList">
                            <li class="empty-msg">No notifications yet‚Ä¶</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üìã</span>
                        <span class="card-hdr-title">Audit Event Log</span>
                        <span class="card-hdr-badge" id="eventCount">0</span>
                    </div>
                    <div class="card-body" style="padding:8px 10px">
                        <ul class="ev-list" id="eventList">
                            <li class="empty-msg">No events yet. Run a simulation!</li>
                        </ul>
                    </div>
                </div>

            </div>

            <!-- ‚îÄ‚îÄ TAB: SIMULATE ‚îÄ‚îÄ -->
            <div class="panel-body" id="tab-sim" style="display:none">

                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">üéÆ</span>
                        <span class="card-hdr-title">Simulation Controls</span>
                    </div>
                    <div class="card-body">
                        <div class="sim-btns">
                            <button class="sim-btn btn-route"  onclick="loadRoadRoute()"><span class="sim-ico">üó∫Ô∏è</span>Load Road Route</button>
                            <button class="sim-btn btn-pickup" onclick="simulatePickup()"><span class="sim-ico">üìç</span>Arrive at Pickup</button>
                            <button class="sim-btn btn-drive"  onclick="simulateDrive()"><span class="sim-ico">üöó</span>Drive to Office</button>
                            <button class="sim-btn btn-office" onclick="simulateOffice()"><span class="sim-ico">üè¢</span>Arrive at Office</button>
                            <button class="sim-btn btn-reset"  onclick="resetTrip()"><span class="sim-ico">üîÑ</span>Reset Trip</button>
                        </div>
                        <div class="sim-bar" id="simStatus" style="margin-top:10px">‚úÖ Ready to simulate</div>
                    </div>
                </div>

                <!-- Speed Monitor -->
                <div class="card">
                    <div class="card-hdr">
                        <span class="card-hdr-icon">‚ö°</span>
                        <span class="card-hdr-title">Live Speed Monitor</span>
                    </div>
                    <div class="card-body">
                        <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px">
                            <div>
                                <div class="spd-num" id="speedLarge">0</div>
                                <div class="spd-unit">km / h</div>
                            </div>
                            <div style="flex:1">
                                <div class="spd-bar-wrap"><div class="spd-bar" id="speedBar" style="width:0%"></div></div>
                                <div style="display:flex;justify-content:space-between;font-size:9px;color:var(--text-3);margin-top:4px">
                                    <span>0</span><span>30</span><span>60</span><span>90</span><span>120</span>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <div class="stat-box" style="flex:1;padding:8px"><div class="stat-val" style="font-size:16px" id="simDist">0</div><div class="stat-lbl">Distance km</div></div>
                            <div class="stat-box" style="flex:1;padding:8px"><div class="stat-val" style="font-size:16px" id="simPings">0</div><div class="stat-lbl">Pings Sent</div></div>
                        </div>
                    </div>
                </div>

            </div>

        </div><!-- /right-panel -->
    </div><!-- /main-content -->
</div><!-- /app-body -->

<div id="toasts" class="toast-wrap"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE ‚Äî multi-vehicle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let map;
let vehicleMarkers  = {};   // vehicleId ‚Üí Leaflet marker
let vehicleTrails   = {};   // vehicleId ‚Üí Leaflet polyline
let trailPoints     = {};   // vehicleId ‚Üí [[lat,lng],...]
let pickupCircles   = {};   // pickupId  ‚Üí Leaflet circle
let officeCircles   = {};   // officeId  ‚Üí Leaflet circle
let roadRouteLayers = {};   // vehicleId ‚Üí Leaflet polyline (planned road route, auto-sim)
let roadRouteLayer  = null, roadRouteWaypoints = [];  // simulate-tab single route
let stompClient = null, wsConnected = false;
let previousEventCount = 0, isSimulating = false;
let pollInterval, simPingCount = 0;
let allTripsData    = [];   // full trip list from API (for filtering)
let notifHistory    = [];

// Active filter state
let fltRegion = '', fltOffice = '', fltRoute = '', fltStatus = 'all', fltTime = '';

// Per-vehicle trail colours (green palette + accents)
const TRAIL_COLORS  = { 1: '#F59E0B', 2: '#3B82F6', 3: '#EC4899' };
const VEHICLE_LABEL = { 1: 'North', 2: 'South', 3: 'East' };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateClock() {
    document.getElementById('liveClock').textContent =
        new Date().toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12: false }) + ' IST';
}
setInterval(updateClock, 1000);
updateClock();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id, el) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel-body').forEach(p => p.style.display = 'none');
    el.classList.add('active');
    document.getElementById('tab-' + id).style.display = 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS ‚Äî live client-side filtering
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setStatusFilter(el, val) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    fltStatus = val;
    applyFilters();
}
function applyFilters() {
    fltRegion = document.getElementById('fltRegion').value;
    fltOffice = document.getElementById('fltOffice').value;
    fltRoute  = document.getElementById('fltRoute').value;
    fltTime   = document.getElementById('fltTime').value;
    updateVehiclesList({ trips: allTripsData });
    syncMapHighlights();
}
function getFilteredTrips() {
    const ROUTE_MAP = { north: 'North Route', south: 'South Route', east: 'East Route' };
    const OFFICE_MAP = { hq: 'Bangalore HQ', itpark: 'IT Park', techhub: 'Tech Hub' };
    const REGION_MAP = { bangalore: 'Bangalore', pune: 'Pune', mumbai: 'Mumbai', hyderabad: 'Hyderabad', chennai: 'Chennai' };

    return allTripsData.filter(t => {
        if (fltStatus === 'active'   && t.status !== 'IN_PROGRESS') return false;
        if (fltStatus === 'delayed'  && t.status !== 'DELAYED')      return false;
        if (fltStatus === 'done'     && t.status !== 'COMPLETED')    return false;
        if (fltRegion  && t.region   !== REGION_MAP[fltRegion])      return false;
        if (fltRoute   && t.route    !== ROUTE_MAP[fltRoute])        return false;
        if (fltOffice  && t.officeName !== OFFICE_MAP[fltOffice])    return false;
        if (fltTime === 'now'     && t.status !== 'IN_PROGRESS')     return false;
        if (fltTime === 'morning' && t.region !== 'Bangalore')       return false;
        return true;
    });
}
/** Dim markers for vehicles that are filtered out */
function syncMapHighlights() {
    const visible = new Set(getFilteredTrips().map(t => t.vehicleId));
    Object.entries(vehicleMarkers).forEach(([vid, m]) => {
        const el = m.getElement();
        if (el) el.style.opacity = (visible.size === 0 || visible.has(Number(vid))) ? '1' : '0.25';
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initMap() {
    map = L.map('map', { zoomControl: true }).setView([12.9400, 77.6100], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOASTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = 'info') {
    const el = document.createElement('div');
    el.className = 'toast t-' + type;
    el.innerHTML = msg;
    document.getElementById('toasts').appendChild(el);
    setTimeout(() => el.remove && el.remove(), 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectWebSocket() {
    try {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        stompClient.connect({}, () => {
            wsConnected = true;
            setConnBadge('ws');
            toast('üîå WebSocket connected ‚Äî 3-vehicle live stream active', 'info');

            // Live GPS pings ‚Äî update each vehicle's marker + trail instantly
            stompClient.subscribe('/topic/location-updates', msg =>
                handleWsUpdate(JSON.parse(msg.body)));

            // Geofence events ‚Äî pickup arrived, trip completed, trip reset
            stompClient.subscribe('/topic/geofence-events', msg =>
                handleGeofenceEvent(JSON.parse(msg.body)));

        }, () => {
            wsConnected = false;
            setConnBadge('poll');
            setTimeout(connectWebSocket, 5000);
        });
    } catch (e) { setConnBadge('disc'); }
}

function setConnBadge(state) {
    const el = document.getElementById('connBadge');
    if (state === 'ws')   { el.className = 'conn-badge conn-ws';   el.innerHTML = '<span class="pulse"></span> WebSocket Live'; }
    else if (state === 'poll') { el.className = 'conn-badge conn-poll'; el.innerHTML = '<span class="pulse"></span> Polling Active'; }
    else                  { el.className = 'conn-badge conn-disc';  el.innerHTML = '<span class="pulse"></span> Disconnected'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIVE WS UPDATE ‚Äî moves correct vehicle marker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleWsUpdate(upd) {
    const vId   = upd.vehicleId;
    const latLng = [upd.latitude, upd.longitude];
    const color  = TRAIL_COLORS[vId] || '#F59E0B';

    // Create or update this vehicle's marker
    if (!vehicleMarkers[vId]) {
        vehicleMarkers[vId] = L.marker(latLng, {
            icon: vehicleIcon(vId, upd.speed),
            zIndexOffset: 1000
        }).addTo(map).bindPopup(buildPopup(upd));
    } else {
        vehicleMarkers[vId].setIcon(vehicleIcon(vId, upd.speed));
        vehicleMarkers[vId].setLatLng(latLng);
        vehicleMarkers[vId].setPopupContent(buildPopup(upd));
    }

    // Extend this vehicle's trail polyline
    if (!trailPoints[vId])  trailPoints[vId] = [];
    trailPoints[vId].push(latLng);
    if (!vehicleTrails[vId]) {
        vehicleTrails[vId] = L.polyline(trailPoints[vId],
            { color, weight: 3.5, opacity: 0.8, lineJoin: 'round' }).addTo(map);
    } else {
        vehicleTrails[vId].setLatLngs(trailPoints[vId]);
    }

    // Map info pill ‚Äî show last updated vehicle
    document.getElementById('mapVehiclePill').style.display = 'flex';
    document.getElementById('mapVehicleInfo').textContent =
        `${upd.vehicleReg || 'V' + vId} ¬∑ ${upd.speed.toFixed(0)} km/h`;

    // Update speed display
    updateSpeedUI(upd.speed);
    document.getElementById('statSpeed').textContent = upd.speed.toFixed(0);
}

function vehicleIcon(vId, speed) {
    const color = TRAIL_COLORS[vId] || '#F59E0B';
    const lbl   = VEHICLE_LABEL[vId] || 'V' + vId;
    return L.divIcon({
        html: `<div style="position:relative;text-align:center">
            <div style="font-size:26px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))">üöê</div>
            <div style="background:${color};color:#fff;font-size:9px;font-weight:800;
                padding:2px 5px;border-radius:8px;margin-top:1px;white-space:nowrap;
                box-shadow:0 1px 3px rgba(0,0,0,.3)">${lbl} ¬∑ ${speed.toFixed(0)}</div>
        </div>`,
        className: '',
        iconSize: [44, 44],
        iconAnchor: [22, 36]
    });
}

function buildPopup(upd) {
    const color = TRAIL_COLORS[upd.vehicleId] || '#F59E0B';
    return `<div class="popup-title" style="color:${color}">üöê ${upd.vehicleReg || 'Vehicle ' + upd.vehicleId}</div>
        <div class="popup-row"><span class="pl">Speed</span><span class="pv">${upd.speed.toFixed(1)} km/h</span></div>
        <div class="popup-row"><span class="pl">Latitude</span><span class="pv">${upd.latitude.toFixed(5)}</span></div>
        <div class="popup-row"><span class="pl">Longitude</span><span class="pv">${upd.longitude.toFixed(5)}</span></div>
        <div class="popup-row"><span class="pl">Trip</span><span class="pv">#${upd.tripId} ¬∑ ${upd.tripStatus || '‚Äî'}</span></div>`;
}

function updateSpeedUI(speed) {
    document.getElementById('speedLarge').textContent = Math.round(speed);
    document.getElementById('speedBar').style.width = Math.min((speed / 120) * 100, 100) + '%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEOFENCE EVENTS ‚Äî instant dashboard reaction
// Triggered by backend /topic/geofence-events topic
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleGeofenceEvent(ev) {
    switch (ev.eventType) {
        case 'TRIP_STARTED':
            toast(`‚ñ∂ ${ev.vehicleReg} trip started ‚Äî loading road route...`, 'info');
            refreshDashboard();
            // Draw planned road route overlay for this vehicle
            loadVehicleRoadRoute(ev.vehicleId, ev.vehicleReg, ev.fromLat, ev.fromLng, ev.toLat, ev.toLng);
            break;
        case 'PICKUP_ARRIVED':
            toast(`üìç ${ev.vehicleReg} arrived at pickup point!`, 'info');
            refreshDashboard();
            break;
        case 'TRIP_COMPLETED':
            toast(`‚úÖ Trip #${ev.tripId} (${ev.vehicleReg}) completed ‚Äî arriving at office!`, 'success');
            refreshDashboard();
            // Auto-switch to Events tab to show the event
            const evTab = document.querySelectorAll('.tab')[2];
            if (evTab) switchTab('events', evTab);
            break;
        case 'TRIP_RESET':
            toast(`üîÑ ${ev.vehicleReg} reset ‚Äî ready to start again`, 'warn');
            const vId = ev.vehicleId;
            if (vehicleTrails[vId])      { map.removeLayer(vehicleTrails[vId]);      delete vehicleTrails[vId];      }
            if (vehicleMarkers[vId])     { map.removeLayer(vehicleMarkers[vId]);     delete vehicleMarkers[vId];     }
            if (trailPoints[vId])        { delete trailPoints[vId]; }
            if (roadRouteLayers[vId])    { map.removeLayer(roadRouteLayers[vId]);    delete roadRouteLayers[vId];    }
            refreshDashboard();
            break;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START TRIP ‚Äî manually dispatches a trip
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startTrip(tripId, vehicleId, vehicleReg) {
    try {
        const btn = document.getElementById('startBtn-' + tripId);
        if (btn) { btn.disabled = true; btn.textContent = 'Loading route...'; }
        const res  = await fetch('/api/dashboard/start-trip/' + tripId, { method: 'POST' });
        const data = await res.json();
        if (!data.success) throw new Error(data.message);
        toast('‚ñ∂ ' + vehicleReg + ' ‚Äî fetching road route from OSRM...', 'info');
        // Backend fires TRIP_STARTED event which calls loadVehicleRoadRoute via WS
        await refreshDashboard();
    } catch (e) {
        toast('‚ùå ' + e.message, 'error');
        const btn = document.getElementById('startBtn-' + tripId);
        if (btn) { btn.disabled = false; btn.textContent = '‚ñ∂ Start Trip'; }
    }
}

// Pickup coords for each vehicle (must match backend ROUTE_STARTS)
const VEHICLE_PICKUP = {
    'KA01AB1234': [12.9520, 77.5750],
    'MH02CD5678': [12.9050, 77.6020],
    'TN03EF9012': [12.9780, 77.6450]
};
const OFFICE_COORDS = [12.9716, 77.5946];

async function loadVehicleRoadRoute(vehicleId, vehicleReg, fromLat, fromLng, toLat, toLng) {
    try {
        const fLat = fromLat || (VEHICLE_PICKUP[vehicleReg] || [12.9520,77.5750])[0];
        const fLng = fromLng || (VEHICLE_PICKUP[vehicleReg] || [12.9520,77.5750])[1];
        const tLat = toLat   || OFFICE_COORDS[0];
        const tLng = toLng   || OFFICE_COORDS[1];
        const url = `https://router.project-osrm.org/route/v1/driving/${fLng},${fLat};${tLng},${tLat}?overview=full&geometries=geojson`;
        const res  = await fetch(url, { signal: AbortSignal.timeout(8000) });
        const json = await res.json();
        if (!json.routes?.length) throw new Error('No OSRM route');
        const pts  = json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
        const color = TRAIL_COLORS[vehicleId] || '#F59E0B';
        if (roadRouteLayers[vehicleId]) map.removeLayer(roadRouteLayers[vehicleId]);
        roadRouteLayers[vehicleId] = L.polyline(pts, {
            color, weight: 4, opacity: 0.45, dashArray: '10, 6', lineJoin: 'round'
        }).addTo(map);
        map.fitBounds(roadRouteLayers[vehicleId].getBounds(), { padding: [40, 40] });
        const dist = (json.routes[0].distance / 1000).toFixed(1);
        toast(`üó∫Ô∏è ${vehicleReg} road route loaded ‚Äî ${dist} km`, 'success');
    } catch(e) {
        toast('‚ö†Ô∏è Road route: ' + (e.message || 'OSRM unavailable'), 'warn');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POLLING ‚Äî every 2 s when not simulating
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function refreshDashboard() {
    try {
        const res = await fetch('/api/dashboard/data');
        if (!res.ok) throw new Error();
        const data = await res.json();
        if (!wsConnected) setConnBadge('poll');
        allTripsData = data.trips || [];
        updateKPIs(data);
        updateStats(data);
        updateMapStatics(data);
        updateEvents(data);
        updateNotifications(data);
        updateVehiclesList({ trips: getFilteredTrips() });
        // Rebuild trails from DB if WS was disconnected
        if (!wsConnected) rebuildTrailsFromLogs(data.locationLogs || []);
    } catch (e) { if (!wsConnected) setConnBadge('disc'); }
}

// Rebuild trails from persisted location logs (e.g. after page reload)
function rebuildTrailsFromLogs(logs) {
    const byVehicle = {};
    logs.forEach(l => {
        if (!byVehicle[l.vehicleId]) byVehicle[l.vehicleId] = [];
        byVehicle[l.vehicleId].push([l.latitude, l.longitude]);
    });
    Object.entries(byVehicle).forEach(([vid, pts]) => {
        const vId = Number(vid);
        const color = TRAIL_COLORS[vId] || '#F59E0B';
        if (pts.length === 0) return;
        trailPoints[vId] = pts;
        if (!vehicleTrails[vId]) {
            vehicleTrails[vId] = L.polyline(pts, { color, weight: 3.5, opacity: 0.8 }).addTo(map);
        } else {
            vehicleTrails[vId].setLatLngs(pts);
        }
        const last = pts[pts.length - 1];
        // Find latest log for this vehicle to get speed
        const latestLog = logs.filter(l => l.vehicleId === vId).slice(-1)[0];
        const spd = latestLog ? latestLog.speed : 0;
        if (!vehicleMarkers[vId]) {
            vehicleMarkers[vId] = L.marker(last, {
                icon: vehicleIcon(vId, spd), zIndexOffset: 1000
            }).addTo(map);
        } else {
            vehicleMarkers[vId].setLatLng(last).setIcon(vehicleIcon(vId, spd));
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KPI STRIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateKPIs(data) {
    const trips     = data.trips || [];
    const ongoing   = trips.filter(t => t.status === 'IN_PROGRESS').length;
    const completed = trips.filter(t => t.status === 'COMPLETED').length;
    const pickups   = (data.pickupPoints || []).filter(p => p.status !== 'ARRIVED').length;
    document.getElementById('kpiOngoing').textContent = ongoing;
    document.getElementById('kpiDelayed').textContent = 0;
    document.getElementById('kpiInGeo').textContent   = completed;
    document.getElementById('kpiNearPU').textContent  = pickups;
    const op = document.getElementById('kpiOngoingPill');
    op.textContent = ongoing > 0 ? ongoing + ' Active' : 'Idle';
    op.className   = 'kpi-pill ' + (ongoing > 0 ? 'pill-green' : 'pill-grey');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VEHICLE LIST ‚Äî uses filtered trips
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateVehiclesList(data) {
    const el = document.getElementById('vehiclesList');
    const trips = data.trips || [];
    if (!trips.length) {
        el.innerHTML = '<div class="empty-msg">No vehicles match the current filters</div>';
        return;
    }
    el.innerHTML = trips.map((t, i) => {
        const color   = TRAIL_COLORS[t.vehicleId] || '#F59E0B';
        const spd     = (t.currentSpeed || 0).toFixed(0);
        const eta     = t.etaMinutes != null ? t.etaMinutes + ' min' : '--';
        const isDone  = t.status === 'COMPLETED';
        const isPend  = t.status === 'PENDING';
        const statusBadge = isDone
            ? `<span class="v-chip" style="background:var(--green-light);color:var(--green-dark)">‚úì Done</span>`
            : isPend
                ? `<span class="v-chip" style="background:#F0F9FF;color:#0369A1">‚è∏ Pending</span>`
                : `<span class="v-chip" style="background:#FEF9EC;color:#D97706">‚óè Live</span>`;
        const startBtn = isPend
            ? `<button id="startBtn-${t.id}" onclick="event.stopPropagation(); startTrip(${t.id}, ${t.vehicleId}, '${t.vehicleReg}')" style="margin-top:6px;width:100%;padding:5px 0;background:var(--green);color:#fff;border:none;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;letter-spacing:0.3px">‚ñ∂ Start Trip</button>`
            : '';
        return `<div class="v-card ${i === 0 ? 'sel' : ''}" onclick="openTripCard(${t.id}, this)">
            <div class="v-avatar" style="background:${color}">üöê</div>
            <div class="v-info">
                <div class="v-reg">${t.vehicleReg || '--'}</div>
                <div class="v-driver">üë§ ${t.driverName || 'Unknown'} ¬∑ <span style="color:var(--text-3)">${t.route || ''}</span></div>
                <div class="v-chips">
                    <span class="v-chip vc-spd">‚ö° ${spd} km/h</span>
                    <span class="v-chip vc-eta">üéØ ETA ${eta}</span>
                    ${statusBadge}
                </div>
                ${startBtn}
            </div>
        </div>`;
    }).join('');
}
function openTripCard(id, el) {
    document.querySelectorAll('.v-card').forEach(c => c.classList.remove('sel'));
    el.classList.add('sel');
    const trip = allTripsData.find(t => t.id === id);
    if (!trip) return;
    // Populate trip tab
    document.getElementById('tripId').textContent     = '#' + trip.id;
    document.getElementById('vehicleReg').textContent = trip.vehicleReg || '‚Äî';
    document.getElementById('tripStart').textContent  = fmt(trip.startTime);
    document.getElementById('tripEnd').textContent    = trip.endTime ? fmt(trip.endTime) : '‚Äî';
    document.getElementById('tripDist').textContent   = trip.totalDistanceKm ? trip.totalDistanceKm.toFixed(2) + ' km' : '0.00 km';
    document.getElementById('tripDur').textContent    = trip.durationMinutes ? trip.durationMinutes + ' min' : '‚Äî';
    const done = trip.status === 'COMPLETED';
    document.getElementById('tripStatus').innerHTML   = done
        ? '<span class="badge b-completed">‚úì Completed</span>'
        : '<span class="badge b-progress">‚óè In Progress</span>';
    document.getElementById('tripStatusBadge').textContent = done ? 'Done' : 'Live';
    document.getElementById('tripStatusBadge').style.background = done ? 'var(--green-dark)' : 'var(--warn)';
    document.getElementById('driverNameLg').textContent  = trip.driverName  || '‚Äî';
    document.getElementById('driverPhoneLg').textContent = trip.driverPhone || '‚Äî';
    document.getElementById('driverLic').textContent     = trip.driverLicense || '‚Äî';
    // Switch to Trip tab
    document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === 1));
    document.querySelectorAll('.panel-body').forEach(p => p.style.display = 'none');
    document.getElementById('tab-trip').style.display = 'flex';
    // Pan map to this vehicle
    if (vehicleMarkers[trip.vehicleId]) {
        map.setView(vehicleMarkers[trip.vehicleId].getLatLng(), 15);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA UPDATERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmt = iso => iso ? new Date(iso).toLocaleTimeString('en-IN',
    { hour:'2-digit', minute:'2-digit', second:'2-digit' }) : '‚Äî';

function updateTripInfo(data) {
    // Trip tab shows first trip by default; clicking a vehicle card updates it
    if (!data.trips.length) return;
    openTripCard(data.trips[0].id, document.querySelector('.v-card') || { classList: { add: ()=>{}, remove: ()=>{} } });
}
function updatePickupInfo(data) {
    if (!data.pickupPoints || !data.pickupPoints.length) return;
    const pp = data.pickupPoints[0];
    document.getElementById('pickupCoords').textContent = pp.latitude.toFixed(4) + ', ' + pp.longitude.toFixed(4);
    document.getElementById('pickupRadius').textContent = pp.radiusMeters + ' m';
    document.getElementById('pickupStatus').innerHTML   =
        pp.status === 'ARRIVED' ? '<span class="badge b-arrived">‚úì Arrived</span>' : '<span class="badge b-pending">‚óè Pending</span>';
}
function updateStats(data) {
    const total = (data.locationLogs || []).length;
    document.getElementById('statPings').textContent  = total;
    document.getElementById('statEvents').textContent = (data.events || []).length;
    document.getElementById('eventCount').textContent = (data.events || []).length;
    // ETA for first active trip
    const active = (data.trips || []).find(t => t.status === 'IN_PROGRESS');
    if (active) {
        document.getElementById('statEta').textContent =
            active.etaMinutes != null ? active.etaMinutes + ' min ‚Üí ' + (active.etaDestination || 'Office') : '‚Äî';
    } else {
        document.getElementById('statEta').textContent = 'All trips complete ‚úì';
    }
    document.getElementById('simDist').textContent =
        ((data.trips || []).reduce((s, t) => s + (t.totalDistanceKm || 0), 0)).toFixed(2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAP STATICS ‚Äî geofence circles (drawn once per ID)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMapStatics(data) {
    // Office geofences
    (data.officeGeofences || []).forEach(of => {
        if (officeCircles[of.id]) return;
        officeCircles[of.id] = L.circle([of.latitude, of.longitude], {
            radius: of.radiusMeters,
            color: '#00A651', fillColor: '#00A651', fillOpacity: 0.1, weight: 2, dashArray: '6,4'
        }).addTo(map);
        L.marker([of.latitude, of.longitude], {
            icon: L.divIcon({ html: '<div style="font-size:22px">üè¢</div>', className: 'emoji-lbl', iconSize: [28,28], iconAnchor: [14,14] })
        }).addTo(map).bindPopup(
            `<b style="color:var(--green-dark)">üè¢ ${of.name || 'Office'}</b><br><small>Radius: ${of.radiusMeters}m</small>`
        );
    });

    // Pickup points ‚Äî each gets its own circle
    (data.pickupPoints || []).forEach(pp => {
        if (pickupCircles[pp.id]) {
            // Update colour if arrived
            if (pp.status === 'ARRIVED') {
                pickupCircles[pp.id].setStyle({ color: '#22C55E', fillColor: '#22C55E' });
            }
            return;
        }
        pickupCircles[pp.id] = L.circle([pp.latitude, pp.longitude], {
            radius: pp.radiusMeters,
            color: '#3B82F6', fillColor: '#3B82F6', fillOpacity: 0.1, weight: 2, dashArray: '6,4'
        }).addTo(map);
        L.marker([pp.latitude, pp.longitude], {
            icon: L.divIcon({ html: '<div style="font-size:22px">üìç</div>', className: 'emoji-lbl', iconSize: [28,28], iconAnchor: [14,14] })
        }).addTo(map).bindPopup(`<b style="color:#1D4ED8">üìç Pickup #${pp.id}</b><br><small>Radius: ${pp.radiusMeters}m</small>`);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EV_META = {
    PICKUP_ARRIVED:   { icon:'üìç', cls:'pickup',   icw:'ic-blue',  label:'Pickup Arrived'        },
    OFFICE_REACHED:   { icon:'üè¢', cls:'office',   icw:'ic-green', label:'Office Reached'        },
    TRIP_COMPLETED:   { icon:'‚úÖ', cls:'complete',  icw:'ic-green', label:'Trip Completed'        },
    MANUAL_CLOSURE:   { icon:'üîí', cls:'complete',  icw:'ic-amber', label:'Manual Closure'        },
    ADMIN_ALERT:      { icon:'üö®', cls:'alert',     icw:'ic-red',   label:'Admin Alert'           },
    GEOFENCE_EXIT:    { icon:'üì§', cls:'alert',     icw:'ic-red',   label:'Geofence Exit'         },
    TRIP_CLOSURE_BLOCKED_MIN_DURATION: { icon:'‚è±Ô∏è', cls:'notif', icw:'ic-amber', label:'Min Duration Block' }
};
function updateEvents(data) {
    const list = document.getElementById('eventList');
    if (!(data.events || []).length) { list.innerHTML = '<li class="empty-msg">No events yet ‚Äî auto-sim will fire events automatically</li>'; return; }
    list.innerHTML = (data.events || []).map(e => {
        const m = EV_META[e.eventType] || { icon:'‚ö°', cls:'', icw:'ic-green', label: e.eventType };
        return `<li class="ev-item ${m.cls}">
            <div class="ev-icon-w ${m.icw}">${m.icon}</div>
            <div><div class="ev-title">${m.label} ‚Äî Trip #${e.tripId}</div>
            <div class="ev-sub">${fmt(e.timestamp)}</div></div>
        </li>`;
    }).join('');
    if ((data.events||[]).length > previousEventCount && previousEventCount > 0) {
        (data.events||[]).slice(0, data.events.length - previousEventCount).forEach(e => {
            const m = EV_META[e.eventType] || { icon:'‚ö°' };
            toast(m.icon + ' ' + (EV_META[e.eventType]?.label || e.eventType), 'success');
        });
    }
    previousEventCount = (data.events||[]).length;
}
function updateNotifications(data) {
    const list = document.getElementById('notifList');
    const notifs = (data.events||[]).filter(e => e.eventType === 'PICKUP_ARRIVED' || e.eventType === 'TRIP_COMPLETED');
    if (!notifs.length) { list.innerHTML = '<li class="empty-msg">No notifications yet ‚Äî system is running automatically</li>'; return; }
    list.innerHTML = notifs.map(e => {
        const isP = e.eventType === 'PICKUP_ARRIVED';
        // find vehicle reg from trips
        const tripData = allTripsData.find(t => t.id === e.tripId);
        const reg = tripData ? tripData.vehicleReg : 'Vehicle';
        return `<li class="ev-item notif">
            <div class="ev-icon-w ic-amber">üì±</div>
            <div><div class="ev-title">${isP ? 'Push: ' + reg + ' arrived!' : 'Push: Trip #' + e.tripId + ' completed!'}</div>
            <div class="ev-sub">${isP ? 'üì≤ SMS + push sent to employee' : 'üì≤ Trip summary SMS sent'} ¬∑ ${fmt(e.timestamp)}</div></div>
        </li>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIMULATION CONTROLS (Demo: manually send pings for vehicle 1)
// Auto-sim runs automatically ‚Äî these are optional overrides
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendPing(lat, lng, speed, vehicleId = 1, tripId = 1) {
    simPingCount++;
    document.getElementById('simPings').textContent = simPingCount;
    const res = await fetch('/api/location/update', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicleId, tripId, latitude: lat, longitude: lng, speed,
            timestamp: new Date().toISOString().slice(0, 19) })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message || 'API error'); }
}
function setSimulating(on, msg) {
    isSimulating = on;
    const el = document.getElementById('simStatus');
    el.textContent = msg || (on ? 'Simulating‚Ä¶' : '‚úÖ Auto-sim running ‚Äî no manual input needed');
    el.className = 'sim-bar' + (on ? ' running' : '');
    document.querySelectorAll('.sim-btn').forEach(b => b.disabled = on);
}
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function simulatePickup() {
    try {
        setSimulating(true, 'üìç Sending pickup ping for vehicle 1‚Ä¶');
        await sendPing(12.9520, 77.5750, 2, 1, 1);
        await sleep(600); await refreshDashboard();
        setSimulating(false, '‚úÖ Pickup ping sent!');
        toast('üìç Vehicle 1 at pickup (manual override)', 'info');
    } catch (e) { setSimulating(false, '‚ùå ' + e.message); toast('Error: ' + e.message, 'error'); }
}
async function simulateDrive() {
    if (roadRouteWaypoints.length === 0) { toast('üó∫Ô∏è Loading road route‚Ä¶', 'info'); const ok = await loadRoadRoute(true); if (!ok) return; }
    const n = roadRouteWaypoints.length;
    const speeds = roadRouteWaypoints.map((_, i) => {
        const t = i / (n - 1);
        if (t < 0.3)      return Math.round(5 + t / 0.3 * 35);
        else if (t < 0.8) return Math.round(38 + Math.sin(t * Math.PI) * 6);
        else              return Math.round(40 - (t - 0.8) / 0.2 * 35);
    });
    try {
        setSimulating(true, 'üöó Driving vehicle 1 along road route‚Ä¶');
        for (let i = 0; i < n; i++) {
            const [lat, lng] = roadRouteWaypoints[i]; const spd = speeds[i];
            setSimulating(true, `üöó Driving‚Ä¶ (${i+1}/${n}) ‚Äî ${spd} km/h`);
            await sendPing(lat, lng, spd, 1, 1);
            updateSpeedUI(spd);
            if (vehicleMarkers[1]) vehicleMarkers[1].setLatLng([lat, lng]);
            await sleep(400);
            if (i % 3 === 0 || i === n - 1) await refreshDashboard();
        }
        setSimulating(false, '‚úÖ Arrived near office!');
        toast('üöó Road route simulation complete', 'success');
    } catch (e) { setSimulating(false, '‚ùå ' + e.message); toast('Error: ' + e.message, 'error'); }
}
async function loadRoadRoute(silent = false) {
    const from = [12.9520, 77.5750], to = [12.9716, 77.5946];
    if (!silent) setSimulating(true, 'üó∫Ô∏è Loading road route from OSRM‚Ä¶');
    try {
        const url = `https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;
        const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
        if (!res.ok) throw new Error('OSRM ' + res.status);
        const json = await res.json();
        if (!json.routes?.length) throw new Error('No route');
        roadRouteWaypoints = json.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
        if (roadRouteLayer) map.removeLayer(roadRouteLayer);
        roadRouteLayer = L.polyline(roadRouteWaypoints, { color: '#A855F7', weight: 5, opacity: 0.75, dashArray: '10, 6', lineJoin: 'round' }).addTo(map);
        map.fitBounds(roadRouteLayer.getBounds(), { padding: [40, 40] });
        const dist = (json.routes[0].distance / 1000).toFixed(2), dur = Math.round(json.routes[0].duration / 60);
        if (!silent) { setSimulating(false, `‚úÖ Route loaded (${dist} km, ~${dur} min)`); toast(`üó∫Ô∏è Road route loaded ‚Äî ${dist} km`, 'success'); }
        return true;
    } catch (e) {
        if (!silent) setSimulating(false, '‚ö†Ô∏è OSRM unavailable ‚Äî fallback path');
        toast('‚ö†Ô∏è OSRM unavailable ‚Äî fallback path', 'warn');
        roadRouteWaypoints = interpolatePath([[12.9520,77.5750],[12.9580,77.5810],[12.9640,77.5875],[12.9716,77.5946]], 20);
        if (roadRouteLayer) map.removeLayer(roadRouteLayer);
        roadRouteLayer = L.polyline(roadRouteWaypoints, { color:'#A855F7', weight:5, opacity:0.65, dashArray:'8, 5', lineJoin:'round' }).addTo(map);
        map.fitBounds(roadRouteLayer.getBounds(), { padding:[40,40] });
        return true;
    }
}
function interpolatePath(pts, n) {
    const r = [];
    for (let s = 0; s < pts.length - 1; s++) {
        const [la1,lo1] = pts[s], [la2,lo2] = pts[s+1];
        for (let i = 0; i <= n; i++) { const t=i/n; r.push([la1+(la2-la1)*t, lo1+(lo2-lo1)*t]); }
    }
    return r;
}
async function simulateOffice() {
    try {
        setSimulating(true, 'üè¢ Sending office arrival for vehicle 1‚Ä¶');
        await sendPing(12.9716, 77.5946, 2, 1, 1);
        await sleep(600); await refreshDashboard();
        setSimulating(false, '‚úÖ Office arrival sent!');
        toast('üè¢ Vehicle 1 at office ‚Äî Trip COMPLETED!', 'success');
    } catch (e) { setSimulating(false, '‚ùå ' + e.message); toast('Error: ' + e.message, 'error'); }
}
async function resetTrip() {
    try {
        setSimulating(true, 'üîÑ Resetting all trips‚Ä¶');
        const res = await fetch('/api/dashboard/reset', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            // Clear all vehicle markers, trails and road route overlays
            Object.values(vehicleMarkers).forEach(m => map.removeLayer(m));
            Object.values(vehicleTrails).forEach(l => map.removeLayer(l));
            Object.values(roadRouteLayers).forEach(l => map.removeLayer(l));
            vehicleMarkers = {}; vehicleTrails = {}; trailPoints = {}; roadRouteLayers = {};
            previousEventCount = 0; notifHistory = []; simPingCount = 0;
            document.getElementById('simPings').textContent = '0';
            updateSpeedUI(0);
            document.getElementById('mapVehiclePill').style.display = 'none';
            await refreshDashboard();
            setSimulating(false, '‚úÖ All trips reset ‚Äî click Start Trip on each vehicle to begin');
            toast('üîÑ All 3 trips reset ‚Äî click Start Trip to begin simulation', 'warn');
        } else throw new Error(data.message);
    } catch (e) { setSimulating(false, '‚ùå ' + e.message); toast('Error: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initMap();
connectWebSocket();
refreshDashboard();
// Poll every 2 s for status, events, KPIs, pickup updates
pollInterval = setInterval(() => { if (!isSimulating) refreshDashboard(); }, 2000);
// Initial status message
setTimeout(() => {
    document.getElementById('simStatus').textContent = '‚è∏ Ready ‚Äî click "Start Trip" on any vehicle to begin road simulation';
}, 1500);
</script>
</body>
</html>
